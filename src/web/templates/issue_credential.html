{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üìù Emissione Nuova Credenziale</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                Dati dello Studente e del Corso
            </div>
            <div class="card-body">
                <form id="issue-credential-form">
                    <!-- Sezione Studente -->
                    <h5 class="mb-3">Dati Anagrafici</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="student_name" class="form-label">Nome e Cognome Studente</label>
                            <input type="text" class="form-control" id="student_name" name="student_name" required placeholder="Es. Mario Rossi">
                        </div>
                        <div class="col-md-6">
                            <label for="student_id" class="form-label">Matricola / ID Studente</label>
                            <input type="text" class="form-control" id="student_id" name="student_id" required placeholder="Es. 0622702628">
                        </div>
                    </div>

                    <!-- Sezione Credenziale -->
                    <h5 class="mb-3 mt-4">Dettagli Credenziale</h5>
                     <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="credential_type" class="form-label">Tipo di Credenziale</label>
                            <select class="form-select" id="credential_type" name="credential_type">
                                <option value="Transcript of Records">Transcript of Records</option>
                                <option value="Diploma Supplement">Diploma Supplement</option>
                                <option value="Attestato di Frequenza">Attestato di Frequenza</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="study_period_start" class="form-label">Inizio Periodo di Studio</label>
                            <input type="date" class="form-control" id="study_period_start" name="study_period_start" required>
                        </div>
                        <div class="col-md-6">
                            <label for="study_period_end" class="form-label">Fine Periodo di Studio</label>
                            <input type="date" class="form-control" id="study_period_end" name="study_period_end" required>
                        </div>
                    </div>
                    
                    <!-- Sezione Corsi (Dinamica) -->
                    <h5 class="mb-3 mt-4">Corsi e Voti</h5>
                    <div id="courses-container">
                        <!-- I corsi verranno aggiunti qui dinamicamente -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addCourse()">Aggiungi Corso</button>
                    
                    <hr class="my-4">

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                            <span id="submit-button-text">Emetti Credenziale</span>
                            <div id="submit-spinner" class="spinner-border spinner-border-sm" role="status" style="display: none;">
                                <span class="visually-hidden">Emissione...</span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                Informazioni
            </div>
            <div class="card-body">
                <p>Compila tutti i campi per emettere una nuova credenziale accademica.</p>
                <p>La credenziale verr√† firmata digitalmente con il certificato dell'universit√† e il suo hash verr√† registrato sulla blockchain (simulata).</p>
                <div id="result-message" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
<script>
    let courseCounter = 0;

    // Funzione per aggiungere dinamicamente un form per un corso
    function addCourse() {
        courseCounter++;
        const container = document.getElementById('courses-container');
        const courseDiv = document.createElement('div');
        courseDiv.classList.add('row', 'mb-3', 'align-items-end');
        courseDiv.innerHTML = `
            <div class="col-md-5">
                <label for="course_name_${courseCounter}" class="form-label">Nome Corso</label>
                <input type="text" class="form-control" id="course_name_${courseCounter}" name="course_name" placeholder="Es. Ingegneria del Software">
            </div>
            <div class="col-md-2">
                <label for="course_cfu_${courseCounter}" class="form-label">CFU</label>
                <input type="number" class="form-control" id="course_cfu_${courseCounter}" name="course_cfu" placeholder="Es. 9" min="1" max="30">
            </div>
            <div class="col-md-2">
                <label for="course_grade_${courseCounter}" class="form-label">Voto</label>
                <input type="text" class="form-control" id="course_grade_${courseCounter}" name="course_grade" placeholder="Es. 30L">
            </div>
            <div class="col-md-2">
                <label for="course_date_${courseCounter}" class="form-label">Data</label>
                <input type="date" class="form-control" id="course_date_${courseCounter}" name="course_date">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">X</button>
            </div>
        `;
        container.appendChild(courseDiv);
    }

    // Gestisce l'invio del form
    document.getElementById('issue-credential-form').addEventListener('submit', async function(event) {
        event.preventDefault(); // Previene il ricaricamento della pagina

        const form = event.target;
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('submit-button-text');
        const spinner = document.getElementById('submit-spinner');
        const resultMessage = document.getElementById('result-message');

        // Mostra lo spinner e disabilita il bottone
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        submitButton.disabled = true;
        resultMessage.innerHTML = '';

        // Validazione form lato client
        const studentName = form.student_name.value.trim();
        const studentId = form.student_id.value.trim();
        const startDate = form.study_period_start.value;
        const endDate = form.study_period_end.value;

        if (!studentName || !studentId || !startDate || !endDate) {
            resultMessage.innerHTML = `<div class="alert alert-warning"><strong>Attenzione!</strong> Compilare tutti i campi obbligatori.</div>`;
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
            return;
        }

        if (new Date(startDate) >= new Date(endDate)) {
            resultMessage.innerHTML = `<div class="alert alert-warning"><strong>Attenzione!</strong> La data di fine deve essere successiva alla data di inizio.</div>`;
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
            return;
        }

        // Controlla che ci sia almeno un corso
        const courseNames = Array.from(form.querySelectorAll('[name="course_name"]')).map(el => el.value.trim()).filter(v => v);
        if (courseNames.length === 0) {
            resultMessage.innerHTML = `<div class="alert alert-warning"><strong>Attenzione!</strong> Aggiungere almeno un corso.</div>`;
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
            return;
        }

        // Validazione corsi
        const courseCfus = Array.from(form.querySelectorAll('[name="course_cfu"]'));
        const courseGrades = Array.from(form.querySelectorAll('[name="course_grade"]'));
        let validationErrors = [];

        for (let i = 0; i < courseNames.length; i++) {
            const cfu = courseCfus[i]?.value;
            const grade = courseGrades[i]?.value.trim();

            if (!cfu || cfu < 1 || cfu > 30) {
                validationErrors.push(`Corso ${i+1}: CFU deve essere tra 1 e 30`);
            }

            if (!grade) {
                validationErrors.push(`Corso ${i+1}: Voto √® obbligatorio`);
            }
        }

        if (validationErrors.length > 0) {
            resultMessage.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Errori di validazione:</strong>
                    <ul class="mb-0 mt-2">
                        ${validationErrors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            `;
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
            return;
        }

        // Raccoglie i dati dal form
        const formData = new FormData(form);
        
        try {
            // Invia i dati all'endpoint API
            const response = await fetch('/credentials/issue', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Successo - mostra dettagli completi
                resultMessage.innerHTML = `
                    <div class="alert alert-success">
                        <h5><strong>‚úÖ Credenziale Emessa con Successo!</strong></h5>
                        <hr>
                        <p><strong>ID Credenziale:</strong> <code>${result.credential_id}</code></p>
                        <p><strong>File salvato in:</strong> <code>${result.file_path}</code></p>
                        <p><strong>Emessa il:</strong> ${new Date(result.issued_at).toLocaleString('it-IT')}</p>
                        <p><strong>Corsi inclusi:</strong> ${result.total_courses}</p>
                        <p><strong>Crediti ECTS totali:</strong> ${result.total_ects}</p>
                        <p class="mb-0"><em>La credenziale √® stata firmata digitalmente e salvata nel sistema.</em></p>
                    </div>
                `;
                
                // Pulisce il form
                form.reset();
                document.getElementById('courses-container').innerHTML = '';
                courseCounter = 0;
                addCourse(); // Aggiunge di nuovo un campo corso vuoto
                
                // Scorri al risultato
                resultMessage.scrollIntoView({ behavior: 'smooth' });
                
            } else {
                throw new Error(result.message || 'Errore sconosciuto dal server.');
            }

        } catch (error) {
            // Gestione errori migliorata
            let errorHtml = `<div class="alert alert-danger">
                <h6><strong>‚ùå Errore durante l'emissione</strong></h6>
                <p>${error.message}</p>
            `;
            
            if (error.message.includes('Validazione')) {
                errorHtml += `<small>Controllare i dati inseriti e riprovare.</small>`;
            } else if (error.message.includes('server')) {
                errorHtml += `<small>Si √® verificato un problema tecnico. Contattare l'amministratore se il problema persiste.</small>`;
            }
            
            errorHtml += `</div>`;
            resultMessage.innerHTML = errorHtml;
            
            console.error('Errore durante l\'emissione:', error);
        } finally {
            // Ripristina il bottone
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
        }
    });

    // Aggiunge un corso di default all'avvio
    addCourse();
</script>
{% endblock %}