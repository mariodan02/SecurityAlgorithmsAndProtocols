{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üìù Emissione Nuova Credenziale</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                Dati dello Studente e del Corso
            </div>
            <div class="card-body">
                <form id="issue-credential-form">
                    <!-- Sezione Studente -->
                    <h5 class="mb-3">Dati Anagrafici</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="student_name" class="form-label">Nome e Cognome Studente</label>
                            <input type="text" class="form-control" id="student_name" name="student_name" required placeholder="Es. Mario Rossi">
                        </div>
                        <div class="col-md-6">
                            <label for="student_id" class="form-label">Matricola / ID Studente</label>
                            <input type="text" class="form-control" id="student_id" name="student_id" required placeholder="Es. 0622702628">
                        </div>
                    </div>

                    <!-- Sezione Credenziale -->
                    <h5 class="mb-3 mt-4">Dettagli Credenziale</h5>
                     <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="credential_type" class="form-label">Tipo di Credenziale</label>
                            <select class="form-select" id="credential_type" name="credential_type">
                                <option value="Transcript of Records">Transcript of Records</option>
                                <option value="Diploma Supplement">Diploma Supplement</option>
                                <option value="Attestato di Frequenza">Attestato di Frequenza</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="study_period_start" class="form-label">Inizio Periodo di Studio</label>
                            <input type="date" class="form-control" id="study_period_start" name="study_period_start" required>
                        </div>
                        <div class="col-md-6">
                            <label for="study_period_end" class="form-label">Fine Periodo di Studio</label>
                            <input type="date" class="form-control" id="study_period_end" name="study_period_end" required>
                        </div>
                    </div>
                    
                    <!-- Sezione Corsi (Dinamica) -->
                    <h5 class="mb-3 mt-4">Corsi e Voti</h5>
                    <div id="courses-container">
                        <!-- I corsi verranno aggiunti qui dinamicamente -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addCourse()">Aggiungi Corso</button>
                    
                    <hr class="my-4">

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                            <span id="submit-button-text">Emetti Credenziale</span>
                            <div id="submit-spinner" class="spinner-border spinner-border-sm" role="status" style="display: none;">
                                <span class="visually-hidden">Emissione...</span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                Informazioni
            </div>
            <div class="card-body">
                <p>Compila tutti i campi per emettere una nuova credenziale accademica.</p>
                <p>La credenziale verr√† firmata digitalmente con il certificato dell'universit√† e il suo hash verr√† registrato sulla blockchain (simulata).</p>
                <div id="result-message" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let courseCounter = 0;

    // Funzione per aggiungere dinamicamente un form per un corso
    function addCourse() {
        courseCounter++;
        const container = document.getElementById('courses-container');
        const courseDiv = document.createElement('div');
        courseDiv.classList.add('row', 'mb-3', 'align-items-end');
        courseDiv.innerHTML = `
            <div class="col-md-5">
                <label for="course_name_${courseCounter}" class="form-label">Nome Corso</label>
                <input type="text" class="form-control" id="course_name_${courseCounter}" name="course_name" placeholder="Es. Ingegneria del Software">
            </div>
            <div class="col-md-2">
                <label for="course_cfu_${courseCounter}" class="form-label">CFU</label>
                <input type="number" class="form-control" id="course_cfu_${courseCounter}" name="course_cfu" placeholder="Es. 9">
            </div>
            <div class="col-md-2">
                <label for="course_grade_${courseCounter}" class="form-label">Voto</label>
                <input type="text" class="form-control" id="course_grade_${courseCounter}" name="course_grade" placeholder="Es. 30L">
            </div>
            <div class="col-md-2">
                <label for="course_date_${courseCounter}" class="form-label">Data</label>
                <input type="date" class="form-control" id="course_date_${courseCounter}" name="course_date">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">X</button>
            </div>
        `;
        container.appendChild(courseDiv);
    }

    // Gestisce l'invio del form
    document.getElementById('issue-credential-form').addEventListener('submit', async function(event) {
        event.preventDefault(); // Previene il ricaricamento della pagina

        const form = event.target;
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('submit-button-text');
        const spinner = document.getElementById('submit-spinner');
        const resultMessage = document.getElementById('result-message');

        // Mostra lo spinner e disabilita il bottone
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';
        submitButton.disabled = true;
        resultMessage.innerHTML = '';

        // Raccoglie i dati dal form
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Raccoglie i dati dei corsi
        data.courses = [];
        const courseNames = formData.getAll('course_name');
        const courseCfus = formData.getAll('course_cfu');
        const courseGrades = formData.getAll('course_grade');
        const courseDates = formData.getAll('course_date');

        for (let i = 0; i < courseNames.length; i++) {
            data.courses.push({
                name: courseNames[i],
                cfu: courseCfus[i],
                grade: courseGrades[i],
                date: courseDates[i]
            });
        }
        
        try {
            // Invia i dati all'endpoint API
            const response = await fetch('/credentials/issue', {
                method: 'POST',
                headers: {
                    // NOTA: Quando si invia un oggetto FormData con fetch, 
                    // il browser imposta automaticamente il Content-Type corretto (multipart/form-data).
                    // Non √® necessario impostarlo manualmente.
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                resultMessage.innerHTML = `<div class="alert alert-success"><strong>Successo!</strong> ${result.message}<br>ID: <code>${result.credential_id}</code></div>`;
                form.reset(); // Pulisce il form
                document.getElementById('courses-container').innerHTML = ''; // Rimuove i corsi
                addCourse(); // Aggiunge di nuovo un campo corso vuoto
            } else {
                throw new Error(result.message || 'Errore sconosciuto dal server.');
            }

        } catch (error) {
            resultMessage.innerHTML = `<div class="alert alert-danger"><strong>Errore!</strong> ${error.message}</div>`;
            console.error('Errore durante l\'emissione:', error);
        } finally {
            // Ripristina il bottone
            buttonText.style.display = 'inline-block';
            spinner.style.display = 'none';
            submitButton.disabled = false;
        }
    });

    // Aggiunge un corso di default all'avvio
    addCourse();
</script>
{% endblock %}
