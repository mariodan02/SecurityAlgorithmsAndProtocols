{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ðŸ§ª Esecuzione Test di Sistema</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Pannello di Controllo Test</div>
            <div class="card-body">
                <p>Esegui la suite di test end-to-end per verificare l'integritÃ  del sistema. (Accesso riservato agli amministratori).</p>
                <button class="btn btn-lg btn-danger" id="run-tests-button">
                    <span id="run-tests-button-text">Avvia Suite di Test Completa</span>
                    <div id="run-tests-spinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></div>
                </button>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header">Ultimo Risultato</div>
            <div class="card-body">
                <p><strong>Data:</strong> {{ test_results.last_run }}</p>
                <p><strong>Esito:</strong> 
                    <span class="badge bg-success">{{ test_results.passed }} Superati</span>
                    <span class="badge bg-danger">{{ test_results.failed }} Falliti</span>
                </p>
                <div class="progress">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="last-test-progress">0%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card" id="test-results-container" style="display: none;">
            <div class="card-header">Risultati Test in Tempo Reale</div>
            <div class="card-body" id="test-results-output">
                <!-- I risultati appariranno qui -->
            </div>
        </div>
    </div>
</div>

<script>
// Inizializza la barra di progresso dell'ultimo test
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.getElementById('last-test-progress');
    if (progressBar) {
        const successRate = '{{ test_results.success_rate }}';
        if (successRate && successRate !== '') {
            progressBar.style.width = successRate;
            progressBar.setAttribute('aria-valuenow', successRate.replace('%', ''));
            progressBar.textContent = successRate;
        }
    }
});

document.getElementById('run-tests-button').addEventListener('click', async function() {
    const button = this;
    const buttonText = document.getElementById('run-tests-button-text');
    const spinner = document.getElementById('run-tests-spinner');
    const resultsContainer = document.getElementById('test-results-container');
    const resultsOutput = document.getElementById('test-results-output');

    // Prepara l'interfaccia per il test
    button.disabled = true;
    buttonText.textContent = 'Esecuzione in corso...';
    spinner.style.display = 'inline-block';
    resultsContainer.style.display = 'block';
    resultsOutput.innerHTML = '<p class="text-info">Avvio dei test...</p>';

    try {
        const response = await fetch('/testing/run', { method: 'POST' });
        const result = await response.json();

        if (response.ok && result.success) {
            const testResult = result.test_result;
            const successRate = (testResult.passed_tests / testResult.total_tests * 100).toFixed(1);
            
            // Pulisce i risultati precedenti
            resultsOutput.innerHTML = '';

            // Crea il titolo del risultato
            const title = document.createElement('h5');
            title.className = 'text-success';
            title.textContent = 'Suite di Test Completata!';
            resultsOutput.appendChild(title);

            // Crea la lista dei risultati
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            
            // Oggetto con i dati dei risultati
            const items = [
                { label: 'ID Test Run', value: '<code>' + testResult.test_run_id + '</code>' },
                { label: 'Durata', value: testResult.duration_sec.toFixed(2) + ' secondi' },
                { label: 'Test Totali', value: testResult.total_tests },
                { label: 'Superati', value: '<span class="text-success fw-bold">' + testResult.passed_tests + '</span>' },
                { label: 'Falliti', value: '<span class="text-danger fw-bold">' + testResult.failed_tests + '</span>' }
            ];

            // Crea gli elementi della lista
            for (let i = 0; i < items.length; i++) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = '<strong>' + items[i].label + ':</strong> ' + items[i].value;
                list.appendChild(li);
            }
            resultsOutput.appendChild(list);

            // Crea la barra di progresso
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress mt-3';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar ' + (successRate > 90 ? 'bg-success' : 'bg-warning');
            progressBar.setAttribute('role', 'progressbar');
            progressBar.style.width = successRate + '%';
            progressBar.setAttribute('aria-valuenow', successRate);
            progressBar.setAttribute('aria-valuemin', '0');
            progressBar.setAttribute('aria-valuemax', '100');
            progressBar.textContent = successRate + '%';
            
            progressContainer.appendChild(progressBar);
            resultsOutput.appendChild(progressContainer);

        } else {
            throw new Error(result.message || 'Errore sconosciuto durante l\'esecuzione dei test.');
        }

    } catch (error) {
        resultsOutput.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = '<strong>Errore:</strong> ' + error.message;
        resultsOutput.appendChild(errorDiv);
    } finally {
        // Ripristina il bottone
        button.disabled = false;
        buttonText.textContent = 'Avvia Suite di Test Completa';
        spinner.style.display = 'none';
    }
});
</script>