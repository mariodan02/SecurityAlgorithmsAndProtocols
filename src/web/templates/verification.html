{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0">Verifica credenziali</h1>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">Verifica presentazione</h6>
                <form id="verify-presentation-form">
                    <div class="mb-3">
                        <label class="form-label">File presentazione (.json)</label>
                        <input class="form-control" type="file" accept=".json" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Scopo della verifica</label>
                        <select class="form-select" name="purpose">
                            <option value="credit_recognition" selected>Riconoscimento crediti</option>
                            <option value="enrollment">Iscrizione corso</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="verify-button">
                        Avvia verifica
                    </button>
                </form>
            </div>
        </div>

        <!-- NUOVO FORM PER VERIFICA COMPLETA -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="text-muted mb-3">Verifica completa</h6>
                <form id="full-verify-form">
                    <div class="mb-3">
                        <label class="form-label">File presentazione (.json)</label>
                        <input class="form-control" type="file" id="fullPresentationFile" accept=".json" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chiave pubblica studente (PEM)</label>
                        <textarea class="form-control" id="studentPublicKey" rows="4" required 
                                  placeholder="-----BEGIN PUBLIC KEY-----&#10;...&#10;-----END PUBLIC KEY-----"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="full-verify-button">
                        <span id="full-verify-text">Verifica completa</span>
                        <span id="full-verify-spinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-4" id="verification-result-container" style="display: none;">
            <div class="card-body">
                <h6 class="text-muted mb-3">Risultato verifica</h6>
                <div id="result-content"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">Verifiche in sospeso</h6>
                <ul class="list-group list-group-flush" id="pending-verifications-list">
                    <li class="list-group-item text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Gestione verifica completa
    document.getElementById('full-verify-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const button = document.getElementById('full-verify-button');
        const buttonText = document.getElementById('full-verify-text');
        const spinner = document.getElementById('full-verify-spinner');
        const fileInput = document.getElementById('fullPresentationFile');
        const publicKey = document.getElementById('studentPublicKey').value;

        if (fileInput.files.length === 0 || !publicKey) {
            alert("Compila tutti i campi");
            return;
        }

        buttonText.style.display = 'none';
        spinner.classList.remove('d-none');
        button.disabled = true;

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const presentationData = JSON.parse(e.target.result);
                
                const response = await fetch('/verification/full-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        presentation_data: presentationData,
                        student_public_key: publicKey,
                        purpose: "credit_recognition"
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayVerificationReport(result.verification_report);
                } else {
                    throw new Error(result.message || 'Errore durante la verifica completa');
                }

            } catch (error) {
                alert(`Errore: ${error.message}`);
            } finally {
                buttonText.style.display = 'inline';
                spinner.classList.add('d-none');
                button.disabled = false;
            }
        };

        reader.readAsText(file);
    });

    // Mostra report dettagliato
    function displayVerificationReport(report) {
        const resultContent = document.getElementById('result-content');
        const resultContainer = document.getElementById('verification-result-container');
        
        let htmlContent = `
            <div class="alert ${report.is_valid ? 'alert-success' : 'alert-danger'}">
                <h5>Risultato verifica: ${report.overall_result}</h5>
                <p>Credenziale: ${report.credential_id}</p>
            </div>
            <div class="mt-3">
                <h6>Dettagli tecnici:</h6>
                <ul>
                    <li>Firma studente: ${report.technical_details.student_signature_valid ? '✅ Valida' : '❌ Non valida'}</li>
                    <li>Firma università: ${report.technical_details.signature_valid ? '✅ Valida' : '❌ Non valida'}</li>
                    <li>Merkle Tree: ${report.technical_details.merkle_tree_valid ? '✅ Valido' : '❌ Non valido'}</li>
                    <li>Revoca blockchain: ${report.technical_details.blockchain_status || 'Non verificato'}</li>
                    <li>Validità temporale: ${report.technical_details.temporal_valid ? '✅ Valida' : '❌ Non valida'}</li>
                </ul>
        `;
        
        if (report.errors.length > 0) {
            htmlContent += `<h6 class="mt-3">Errori:</h6><ul>`;
            report.errors.forEach(error => {
                htmlContent += `<li>${error.message} [${error.code}]</li>`;
            });
            htmlContent += `</ul>`;
        }
        
        if (report.warnings.length > 0) {
            htmlContent += `<h6 class="mt-3">Warning:</h6><ul>`;
            report.warnings.forEach(warning => {
                htmlContent += `<li>${warning.message} [${warning.code}]</li>`;
            });
            htmlContent += `</ul>`;
        }
        
        resultContent.innerHTML = htmlContent;
        resultContainer.style.display = 'block';
    }
    
    // Aggiungere solo il nuovo codice per la verifica completa:
    document.getElementById('full-verify-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const button = document.getElementById('full-verify-button');
        const buttonText = document.getElementById('full-verify-text');
        const spinner = document.getElementById('full-verify-spinner');
        const fileInput = document.getElementById('fullPresentationFile');
        const publicKeyTextarea = document.getElementById('studentPublicKey');

        if (fileInput.files.length === 0 || !publicKeyTextarea.value.trim()) {
            alert("Per favore, carica un file e inserisci la chiave pubblica");
            return;
        }

        button.disabled = true;
        buttonText.style.display = 'none';
        spinner.classList.remove('d-none');

        try {
            const file = fileInput.files[0];
            const publicKey = publicKeyTextarea.value.trim();
            const presentationData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(JSON.parse(e.target.result));
                reader.onerror = (e) => reject(new Error("Errore lettura file"));
                reader.readAsText(file);
            });

            const response = await fetch('/verification/full-verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    presentation_data: presentationData,
                    student_public_key: publicKey,
                    purpose: "credit_recognition"
                })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                displayVerificationReport(result.verification_report);
            } else {
                throw new Error(result.message || 'Errore durante la verifica');
            }
        } catch (error) {
            alert(`Errore: ${error.message}`);
        } finally {
            button.disabled = false;
            buttonText.style.display = 'inline';
            spinner.classList.add('d-none');
        }
    });

    function displayVerificationReport(report) {
        const resultContent = document.getElementById('result-content');
        const resultContainer = document.getElementById('verification-result-container');
        
        let html = `<div class="alert ${report.is_valid ? 'alert-success' : 'alert-danger'}">`;
        html += `<h5>Risultato verifica: ${report.overall_result.toUpperCase()}</h5>`;
        html += `<p>Credenziale: ${report.credential_id}</p>`;
        html += `<p>Livello validazione: ${report.validation_level}</p>`;
        html += `</div>`;
        
        html += `<div class="mt-4"><h6>Dettagli tecnici:</h6>`;
        html += `<ul class="list-group">`;
        html += `<li class="list-group-item">Firma studente: ${report.technical_details.student_signature_valid ? '✅ VALIDA' : '❌ NON VALIDA'}</li>`;
        html += `<li class="list-group-item">Firma università: ${report.technical_details.signature_valid ? '✅ VALIDA' : '❌ NON VALIDA'}</li>`;
        html += `<li class="list-group-item">Merkle Tree: ${report.technical_details.merkle_tree_valid ? '✅ VALIDO' : '❌ NON VALIDO'}</li>`;
        html += `<li class="list-group-item">Revoca blockchain: ${report.technical_details.blockchain_status || 'Non verificato'}</li>`;
        html += `<li class="list-group-item">Validità temporale: ${report.technical_details.temporal_valid ? '✅ VALIDA' : '❌ NON VALIDA'}</li>`;
        html += `</ul></div>`;
        
        if (report.errors.length > 0) {
            html += `<div class="mt-4"><h6>Errori riscontrati:</h6><ul>`;
            report.errors.forEach(error => {
                html += `<li class="text-danger">${error.message} [codice: ${error.code}]</li>`;
            });
            html += `</ul></div>`;
        }
        
        if (report.warnings.length > 0) {
            html += `<div class="mt-3"><h6>Avvertenze:</h6><ul>`;
            report.warnings.forEach(warning => {
                html += `<li class="text-warning">${warning.message} [codice: ${warning.code}]</li>`;
            });
            html += `</ul></div>`;
        }
        
        resultContent.innerHTML = html;
        resultContainer.style.display = 'block';
        
        // Scroll automatico ai risultati
        resultContainer.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}