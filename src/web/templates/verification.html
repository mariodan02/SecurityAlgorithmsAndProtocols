{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0">üîç Verifica credenziali</h1>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">üîê Verifica completa presentazione selettiva</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info small">
                    <strong>Processo di verifica:</strong>
                    <ol class="mb-0 mt-2">
                        <li>Verifica firma digitale studente</li>
                        <li>Controllo Merkle Proof per divulgazione selettiva</li>
                        <li>Verifica firma universit√† emittente</li>
                        <li>Controllo stato revoca su blockchain</li>
                        <li>Validazione temporale</li>
                    </ol>
                </div>
                
                <form id="full-verify-form">
                    <div class="mb-3">
                        <label class="form-label">File presentazione (.json) *</label>
                        <input class="form-control" type="file" id="presentationFile" accept=".json" required>
                        <div class="form-text">File JSON della presentazione verificabile creata dallo studente</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chiave pubblica studente (PEM) *</label>
                        <textarea class="form-control font-monospace" id="studentPublicKey" rows="6" required 
                                  placeholder="-----BEGIN PUBLIC KEY-----&#10;MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...&#10;-----END PUBLIC KEY-----"></textarea>
                        <div class="form-text">Chiave pubblica PEM del wallet dello studente</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Scopo della verifica</label>
                        <select class="form-select" id="verificationPurpose">
                            <option value="credit_recognition">Riconoscimento crediti CFU</option>
                            <option value="enrollment">Verifica per iscrizione</option>
                            <option value="degree_validation">Validazione titolo</option>
                            <option value="erasmus_application">Domanda Erasmus</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="verifyButton">
                        <span id="verifyText">üîç Avvia verifica completa</span>
                        <span id="verifySpinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-4" id="verificationResults" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">üìä Risultati verifica</h6>
            </div>
            <div class="card-body">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">üìñ Guida verifica</h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">Processo di verifica</h6>
                <div class="small text-muted">
                    <p><strong>1. Firma studente:</strong> Garantisce autenticit√† e non-ripudio</p>
                    <p><strong>2. Merkle Proof:</strong> Verifica integrit√† divulgazione selettiva</p>
                    <p><strong>3. Firma universit√†:</strong> Conferma validit√† istituzionale</p>
                    <p><strong>4. Blockchain:</strong> Controllo stato revoca</p>
                    <p><strong>5. Temporale:</strong> Verifica scadenze e coerenza</p>
                </div>
                
                <hr>
                
                <h6 class="text-primary">Risultati possibili</h6>
                <div class="small">
                    <p><span class="badge bg-success">VALIDA</span> Tutti i controlli superati</p>
                    <p><span class="badge bg-warning">WARNING</span> Valida con avvertenze</p>
                    <p><span class="badge bg-danger">INVALIDA</span> Controlli falliti</p>
                    <p><span class="badge bg-danger">REVOCATA</span> La credenziale non √® pi√π valida</p>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">üìà Statistiche verifiche</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="h4 text-success mb-0">94.7%</div>
                    <div class="small text-muted">Tasso successo</div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="fw-bold text-primary">32</div>
                        <div class="small text-muted">Verificate</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-warning">5</div>
                        <div class="small text-muted">In sospeso</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-danger">2</div>
                        <div class="small text-muted">Respinte</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('full-verify-form');
    const fileInput = document.getElementById('presentationFile');
    const publicKeyInput = document.getElementById('studentPublicKey');
    const verifyButton = document.getElementById('verifyButton');
    const verifyText = document.getElementById('verifyText');
    const verifySpinner = document.getElementById('verifySpinner');
    const resultsCard = document.getElementById('verificationResults');
    const resultContent = document.getElementById('resultContent');

    // Gestione submit form
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (!validateForm()) return;
        
        setLoadingState(true);
        
        try {
            const presentationData = await readFileAsJSON(fileInput.files[0]);
            const publicKey = publicKeyInput.value.trim();
            const purpose = document.getElementById('verificationPurpose').value;
            
            const requestData = {
                presentation_data: presentationData,
                student_public_key: publicKey,
                purpose: purpose
            };
            
            console.log('üîç Invio richiesta verifica:', requestData);
            
            const response = await fetch('/verification/full-verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                displayVerificationReport(result.verification_report);
            } else {
                throw new Error(result.message || 'Errore durante la verifica');
            }
            
        } catch (error) {
            console.error('‚ùå Errore verifica:', error);
            displayError(error.message);
        } finally {
            setLoadingState(false);
        }
    });
    
    function validateForm() {
        if (fileInput.files.length === 0) {
            alert('Seleziona un file di presentazione');
            fileInput.focus();
            return false;
        }
        
        if (!publicKeyInput.value.trim()) {
            alert('Inserisci la chiave pubblica dello studente');
            publicKeyInput.focus();
            return false;
        }
        
        return true;
    }
    
    function setLoadingState(loading) {
        verifyButton.disabled = loading;
        if (loading) {
            verifyText.style.display = 'none';
            verifySpinner.classList.remove('d-none');
        } else {
            verifyText.style.display = 'inline';
            verifySpinner.classList.add('d-none');
        }
    }
    
    async function readFileAsJSON(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    resolve(json);
                } catch (error) {
                    reject(new Error('File JSON non valido'));
                }
            };
            reader.onerror = () => reject(new Error('Errore lettura file'));
            reader.readAsText(file);
        });
    }
    
    function displayVerificationReport(report) {
        console.log('üìä Report verifica ricevuto:', report);
        
        const isValid = report.is_valid;
        const result = report.overall_result.toUpperCase();
        
        let resultText = result;
        if (result === 'REVOKED') {
            resultText = 'CREDENZIALE REVOCATA';
        }
        
        let html = '';
        
        // Header risultato
        html += `<div class="alert ${getAlertClass(result)} border-0">`;
        html += `<div class="d-flex align-items-center">`;
        html += `<div class="me-3">${getResultIcon(result)}</div>`;
        html += `<div>`;
        html += `<h5 class="mb-1">Risultato: ${resultText}</h5>`;
        html += `<div class="small">Credenziale: ${report.credential_id}</div>`;
        html += `<div class="small">Livello: ${report.validation_level} | ${new Date(report.timestamp).toLocaleString('it-IT')}</div>`;
        html += `</div></div></div>`;
        
        // Dettagli tecnici
        html += `<div class="row g-3 mb-4">`;
        html += createVerificationCard('üë§ Firma Studente', report.technical_details.student_signature_valid);
        html += createVerificationCard('üèõÔ∏è Firma Universit√†', report.technical_details.signature_valid);
        html += createVerificationCard('üå≥ Merkle Tree', report.technical_details.merkle_tree_valid);
        html += createVerificationCard('‚è∞ Validit√† Temporale', report.technical_details.temporal_valid);
        html += createBlockchainCard('üîó Blockchain', report.technical_details.blockchain_status);
        html += `</div>`;
        
        // Errori
        if (report.errors && report.errors.length > 0) {
            html += `<div class="alert alert-danger border-0">`;
            html += `<h6 class="alert-heading">‚ùå Errori rilevati (${report.errors.length})</h6>`;
            html += `<ul class="mb-0">`;
            report.errors.forEach(error => {
                html += `<li><strong>${error.code}:</strong> ${error.message}</li>`;
            });
            html += `</ul></div>`;
        }
        
        // Warning
        if (report.warnings && report.warnings.length > 0) {
            html += `<div class="alert alert-warning border-0">`;
            html += `<h6 class="alert-heading">‚ö†Ô∏è Avvertenze (${report.warnings.length})</h6>`;
            html += `<ul class="mb-0">`;
            report.warnings.forEach(warning => {
                html += `<li><strong>${warning.code}:</strong> ${warning.message}</li>`;
            });
            html += `</ul></div>`;
        }
        
        // Informazioni aggiuntive
        if (report.info && report.info.length > 0) {
            html += `<div class="alert alert-info border-0">`;
            html += `<h6 class="alert-heading">‚ÑπÔ∏è Informazioni</h6>`;
            html += `<ul class="mb-0">`;
            report.info.forEach(info => {
                html += `<li>${info.message}</li>`;
            });
            html += `</ul></div>`;
        }
        
        resultContent.innerHTML = html;
        resultsCard.style.display = 'block';
        resultsCard.scrollIntoView({ behavior: 'smooth' });
    }
    
    function displayError(message) {
        const html = `
            <div class="alert alert-danger border-0">
                <h5 class="alert-heading">‚ùå Errore verifica</h5>
                <p class="mb-0">${message}</p>
            </div>
        `;
        resultContent.innerHTML = html;
        resultsCard.style.display = 'block';
        resultsCard.scrollIntoView({ behavior: 'smooth' });
    }
    
    function getAlertClass(result) {
        switch(result) {
            case 'VALID': return 'alert-success';
            case 'WARNING': return 'alert-warning';
            case 'INVALID': return 'alert-danger';
            case 'REVOKED': return 'alert-danger';
            default: return 'alert-secondary';
        }
    }
    
    function getResultIcon(result) {
        switch(result) {
            case 'VALID': return '‚úÖ';
            case 'WARNING': return '‚ö†Ô∏è';
            case 'INVALID': return '‚ùå';
            case 'REVOKED': return 'üö´';
            default: return '‚ùì';
        }
    }
    
    function createVerificationCard(title, isValid) {
        const icon = isValid ? '‚úÖ' : '‚ùå';
        const badgeClass = isValid ? 'bg-success' : 'bg-danger';
        const status = isValid ? 'VALIDA' : 'NON VALIDA';
        
        return `
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="small fw-medium">${title}</div>
                            <span class="badge ${badgeClass}">${icon} ${status}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createBlockchainCard(title, status) {
        let icon, badgeClass, displayStatus;
        
        switch(status) {
            case 'valid':
                icon = '‚úÖ'; badgeClass = 'bg-success'; displayStatus = 'VALIDA';
                break;
            case 'revoked':
                icon = 'üö´'; badgeClass = 'bg-danger'; displayStatus = 'REVOCATA';
                break;
            case 'error':
                icon = '‚ö†Ô∏è'; badgeClass = 'bg-warning'; displayStatus = 'ERRORE';
                break;
            default:
                icon = '‚ùì'; badgeClass = 'bg-secondary'; displayStatus = 'NON VERIFICATA';
        }
        
        return `
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="small fw-medium">${title}</div>
                            <span class="badge ${badgeClass}">${icon} ${displayStatus}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
});
</script>
{% endblock %}