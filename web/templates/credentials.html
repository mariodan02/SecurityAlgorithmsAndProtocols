{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ðŸ“‹ Gestione Credenziali</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/credentials/issue" class="btn btn-sm btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            Emetti Nuova Credenziale
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Credenziali Emesse
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">ID Credenziale</th>
                        <th scope="col">Nome Studente</th>
                        <th scope="col">Data Emissione</th>
                        <th scope="col">Emessa Da</th>
                        <th scope="col">Stato</th>
                        <th scope="col">Azioni</th>
                    </tr>
                </thead>
                <tbody id="credentials-table-body">
                    <!-- I dati verranno caricati qui dinamicamente -->
                </tbody>
            </table>
        </div>
        <div id="loading-spinner" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
        </div>
    </div>
</div>

<!-- Esempio di Modale per Dettagli (da implementare) -->
<div class="modal fade" id="credentialDetailModal" tabindex="-1" aria-labelledby="credentialDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="credentialDetailModalLabel">Dettaglio Credenziale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>ID:</strong> <span id="modal-cred-id"></span></p>
        <p><strong>Dati completi:</strong></p>
        <pre><code id="modal-cred-data" class="json"></code></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-danger">Revoca Credenziale</button>
      </div>
    </div>
  </div>
</div>


<script>
    // Funzione per caricare dinamicamente le credenziali dall'API
    async function fetchCredentials() {
        const spinner = document.getElementById('loading-spinner');
        const tableBody = document.getElementById('credentials-table-body');
        
        spinner.style.display = 'block'; // Mostra lo spinner
        tableBody.innerHTML = ''; // Pulisce la tabella

        try {
            const response = await fetch('/api/credentials');
            if (!response.ok) {
                throw new Error(`Errore HTTP: ${response.status}`);
            }
            const data = await response.json();
            
            if (data.credentials && data.credentials.length > 0) {
                data.credentials.forEach(cred => {
                    const row = `
                        <tr>
                            <td><code>${cred.credential_id}</code></td>
                            <td>${cred.student_name}</td>
                            <td>${new Date(cred.issued_at).toLocaleString('it-IT')}</td>
                            <td>${cred.issued_by}</td>
                            <td><span class="badge bg-${cred.status === 'active' ? 'success' : 'danger'}">${cred.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="showDetails('${cred.credential_id}')" data-bs-toggle="modal" data-bs-target="#credentialDetailModal">Dettagli</button>
                                <button class="btn btn-sm btn-warning">Presenta</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nessuna credenziale trovata.</td></tr>';
            }

        } catch (error) {
            console.error('Errore nel caricamento delle credenziali:', error);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Impossibile caricare i dati. ${error.message}</td></tr>`;
        } finally {
            spinner.style.display = 'none'; // Nasconde lo spinner
        }
    }

    // Funzione per mostrare i dettagli in un modale (esempio)
    function showDetails(credentialId) {
        // In un'applicazione reale, faresti un'altra chiamata API per ottenere i dettagli completi
        document.getElementById('modal-cred-id').textContent = credentialId;
        const mockDetails = {
            id: credentialId,
            description: "Dettagli completi della credenziale caricati via API."
        };
        document.getElementById('modal-cred-data').textContent = JSON.stringify(mockDetails, null, 2);
    }

    // Carica i dati quando la pagina Ã¨ pronta
    document.addEventListener('DOMContentLoaded', fetchCredentials);
</script>